{# --- START OF (REVISED) FILE app/templates/search.html --- #}
{% extends 'base.html' %}

{% block title %}
    {% if main_artist %}
        {{ main_artist.name }} - Artist Metrics
    {% else %}
        Search Artist - Spotify Metrics
    {% endif %}
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6 text-center">Search for an Artist</h1>

{# Search Form (with loading) #}
<div class="mb-8 max-w-xl mx-auto">
    <form method="GET" action="{{ url_for('main.search_artist') }}" id="artist-search-form" class="relative">
        <div class="flex items-center bg-gray-800 rounded-full shadow-md overflow-hidden">
            <input type="text" name="query" id="artist-query-input" placeholder="Enter artist name..." value="{{ query or '' }}" required class="w-full px-6 py-3 bg-transparent text-white focus:outline-none peer">
            <button type="submit" id="artist-search-button" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold transition duration-300 disabled:opacity-70 disabled:cursor-wait">
                <span class="button-text">Search</span>
                <span class="button-loading hidden animate-pulse">Searching...</span>
            </button>
        </div>
        <div id="search-loading-indicator" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hidden">
             <div class="loader inline-block border-2 border-gray-500 border-t-green-400 rounded-full w-6 h-6 animate-spin"></div>
        </div>
    </form>
     <p id="search-status-text" class="text-center text-xs text-gray-500 mt-2 h-4"></p>
</div>

{# Display Search Results #}
{% if search_performed %}
    {% if main_artist %}
        {# Artist Found - Display Details using Partial #}
        <h2 class="text-2xl font-bold mb-4 text-center text-green-300">Search Result: {{ main_artist.name }}</h2>

        {# Links to related pages #}
        <div class="text-center mb-8 flex flex-wrap justify-center gap-4">
             <a href="{{ url_for('main.similar_artists', artist_id=main_artist.id) }}"
                id="view-similar-button"
                class="inline-block px-6 py-2 bg-blue-500 rounded text-lg font-semibold hover:bg-blue-600 transition duration-300 relative disabled:opacity-70 disabled:cursor-wait">
                 <span class="button-text">View Similar Artists</span>
                 <span class="button-loading hidden animate-pulse">Loading...</span>
             </a>
             <a href="{{ url_for('playlists.show_playlist_finder', artist_id=main_artist.id) }}"
                id="find-playlists-button"
                class="inline-block px-6 py-2 bg-purple-600 rounded text-lg font-semibold hover:bg-purple-700 transition duration-300 relative disabled:opacity-70 disabled:cursor-wait">
                 <span class="button-text">Find Playlists for Artist</span>
                 <span class="button-loading hidden animate-pulse">Loading...</span>
             </a>
        </div>

        {# Include the Spotify artist details partial #}
        {% set display_artist = main_artist %}
        {% set display_releases = main_artist_releases %}
        {% set top_tracks = top_tracks %}
        {% set release_stats = release_stats %}
        {% include '_artist_display.html' %}

        {# --- ****** NEW: Last.fm Events Section ****** --- #}
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mt-[-1rem] mb-10"> {# Negative margin to pull up slightly #}
            <h4 class="text-xl font-semibold mb-4 text-center text-red-400">Upcoming Events (from Last.fm)</h4>
            {% if lastfm_events %}
                <ul class="space-y-4">
                    {% for event in lastfm_events %}
                        <li class="flex flex-col sm:flex-row items-start sm:items-center border-b border-gray-700 pb-3 last:border-b-0">
                            {# Date Section #}
                            <div class="w-full sm:w-24 text-center sm:text-left mb-2 sm:mb-0 sm:mr-4 flex-shrink-0">
                                <p class="text-lg font-semibold text-gray-200 leading-tight">{{ event.date.split(' ')[1] or '?' }}</p> {# Day #}
                                <p class="text-xs uppercase text-gray-400">{{ event.date.split(' ')[0] or 'Date' }}{% if event.date.split(' ')|length > 2 %}, {{ event.date.split(' ')[2] }}{% endif %}</p> {# Month/Year #}
                            </div>
                            {# Details Section #}
                            <div class="flex-grow">
                                {% if event.url %}
                                <a href="{{ event.url }}" target="_blank" rel="noopener noreferrer" class="text-green-400 hover:text-green-300 font-semibold block hover:underline" title="{{ event.title }}">
                                    {{ event.title }} â†—
                                </a>
                                {% else %}
                                <p class="text-gray-100 font-semibold block">{{ event.title }}</p>
                                {% endif %}
                                <p class="text-sm text-gray-300 mt-1">{{ event.venue | default('Venue not specified') }}</p>
                                <p class="text-xs text-gray-500">{{ event.location | default('Location not specified') }}</p>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
             {% elif lastfm_events is not none %} {# Check for empty list vs scrape error #}
                <p class="text-center text-gray-500 italic">No upcoming events found for {{ main_artist.name }} on Last.fm.</p>
             {% else %} {# lastfm_events is None - indicating scrape error handled in route #}
                  <p class="text-center text-yellow-500 italic">Could not load event data from Last.fm.</p>
             {% endif %}
              <p class="text-xs text-gray-600 mt-4 text-center">Event data scraped from Last.fm. Accuracy not guaranteed.</p>
        </div>
        {# --- ****** End Last.fm Events Section ****** --- #}

    {% else %}
        {# No artist found message #}
        <div class="text-center p-10 bg-gray-800 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-4">No Artist Found</h2>
            {% if query %}
                <p class="text-gray-400">Could not find any artist matching "{{ query }}". Please try a different search term.</p>
            {% else %}
                 <p class="text-gray-400">Could not retrieve details for the previously searched artist.</p>
            {% endif %}
        </div>
    {% endif %}
{% else %}
   {# Initial state #}
   <div class="text-center p-10 bg-gray-800 rounded-lg shadow-xl">
       <p class="text-gray-400">Enter an artist name above to view their metrics. The last searched artist will be shown if you return to this page.</p>
   </div>
{% endif %} {# end search_performed #}

{% endblock %}

{# (Keep extra_js block from previous step for search/nav loading) #}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Search Form Logic ---
        const searchForm = document.getElementById('artist-search-form');
        const searchButton = document.getElementById('artist-search-button');
        const queryInput = document.getElementById('artist-query-input');
        const searchLoadingIndicator = document.getElementById('search-loading-indicator');
        const searchStatusText = document.getElementById('search-status-text');
        const searchButtonTextSpan = searchButton ? searchButton.querySelector('.button-text') : null;
        const searchButtonLoadingSpan = searchButton ? searchButton.querySelector('.button-loading') : null;

        if (searchForm && searchButton && queryInput && searchLoadingIndicator && searchButtonTextSpan && searchButtonLoadingSpan && searchStatusText) {
            searchForm.addEventListener('submit', function(event) {
                if (!queryInput.value.trim()) {
                    searchStatusText.textContent = 'Please enter an artist name.';
                    searchStatusText.classList.add('text-red-400');
                    event.preventDefault();
                    return;
                }
                searchButton.disabled = true;
                searchButtonTextSpan.classList.add('hidden');
                searchButtonLoadingSpan.classList.remove('hidden');
                searchLoadingIndicator.classList.remove('hidden');
                queryInput.classList.add('opacity-50');
                searchStatusText.textContent = 'Searching...';
                searchStatusText.classList.remove('text-red-400');
            });
        } else {
            console.error("Search form elements not found for loading indicator setup.");
        }

        // --- Navigation Button Logic ---
        function setupNavLinkLoading(buttonId) {
            const navButton = document.getElementById(buttonId);
            const buttonTextSpan = navButton ? navButton.querySelector('.button-text') : null;
            const buttonLoadingSpan = navButton ? navButton.querySelector('.button-loading') : null;

            if (navButton && buttonTextSpan && buttonLoadingSpan) {
                navButton.addEventListener('click', function(e) { // Pass event 'e'
                    // Check if already disabled
                    if (navButton.classList.contains('disabled')) {
                        e.preventDefault(); // Prevent navigation if already clicked
                        return;
                    }

                    navButton.classList.add('disabled', 'pointer-events-none');
                    buttonTextSpan.classList.add('hidden');
                    buttonLoadingSpan.classList.remove('hidden');
                    // Don't prevent default, let the navigation happen
                });

                window.addEventListener('pageshow', function(event) {
                     if (event.persisted) {
                         navButton.classList.remove('disabled', 'pointer-events-none');
                         buttonTextSpan.classList.remove('hidden');
                         buttonLoadingSpan.classList.add('hidden');
                     }
                 });

            } else {
                 console.warn(`Navigation button elements not found for ID: ${buttonId}`);
            }
        }
        setupNavLinkLoading('view-similar-button');
        setupNavLinkLoading('find-playlists-button'); // Assumes this button exists

    });
</script>
{% endblock %}
{# --- END OF (REVISED) FILE app/templates/search.html --- #}