{# --- START OF (CORRECTED) FILE templates/playlist_finder_base.html --- #}
{% extends 'base.html' %}

{% block title %}
    {% if request.args.get('selected_track_id') %} {# Check if search was performed based on URL param #}
        Playlist Results for {{ artist_name }}
    {% else %}
        Find Playlists for {{ artist_name }}
    {% endif %}
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4 text-center">Find Playlists & Contact Curators for {{ artist_name }}</h1>
<p class="text-center text-gray-400 text-sm mb-6">Select a track by {{ artist_name }}, find relevant playlists, then generate & send outreach emails (experimental).</p>



{# --- Main Content Area (Two Columns) --- #}
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

    {# --- Left Column (Wider): Form --- #}
    <div class="lg:col-span-7 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
        <form method="GET" action="{{ url_for('playlists.show_playlist_finder', artist_id=artist_id) }}" id="playlist-finder-form">
            {# 1. Track Selection #}
            <h2 class="text-xl font-semibold mb-3 text-center">1. Select a Song by {{ artist_name }}</h2>

            {# NEW: Song Search Bar #}
            <div class="mb-4 relative">
                <input type="search" id="song-search-input" placeholder="Search for a song..."
                       class="w-full px-4 py-2 pl-10 bg-gray-700 border border-gray-600 rounded-md focus:ring-green-500 focus:border-green-500 text-white">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>


            {% if all_artist_tracks %}
                <div id="song-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar">
                    {% for track in all_artist_tracks %}
                    <label class="flex items-center bg-gray-700 p-3 rounded-lg shadow hover:bg-gray-650 transition duration-200 cursor-pointer border-2 border-transparent has-[:checked]:border-green-500 has-[:checked]:bg-gray-700 group"
                           data-track-name="{{ track.name | lower }}" data-album-name="{{ track.album.name | lower if track.album else '' }}">
                         <input type="radio" name="selected_track_id" value="{{ track.id }}" class="absolute opacity-0 w-0 h-0 peer" required
                               {% if track.id == request.args.get('selected_track_id') %}checked{% endif %}>
                         {% if track.album and track.album.images %}
                            <img src="{{ track.album.images[-1].url }}" alt="{{ track.album.name }} Cover" class="w-12 h-12 rounded flex-shrink-0 object-cover mr-3 border border-gray-600">
                         {% else %}
                            <div class="w-12 h-12 rounded flex-shrink-0 bg-gray-600 flex items-center justify-center mr-3 text-gray-500 text-xl">?</div>
                         {% endif %}
                         <div class="flex-grow overflow-hidden">
                             <span class="block text-sm font-medium text-gray-100 truncate group-hover:text-white" title="{{ track.name }}">{{ track.name }}</span>
                             <span class="block text-xs text-gray-400 truncate" title="{{ track.artists | map(attribute='name') | join(', ') }}">
                                 {{ track.artists | map(attribute='name') | join(', ') }}
                                 {% if track.album %} ‚Ä¢ <span class="italic">{{ track.album.name }}</span>{% endif %}
                             </span>
                         </div>
                         <div class="ml-auto flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-500 group-has-[:checked]:border-green-500 group-has-[:checked]:bg-green-500 flex items-center justify-center transition-colors duration-200">
                              <svg class="w-3 h-3 text-white opacity-0 group-has-[:checked]:opacity-100 transition-opacity duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                         </div>
                    </label>
                    {% endfor %}
                </div>
                <p id="no-song-results" class="text-center text-gray-500 italic mb-4 hidden">No songs match your search.</p>
            {% elif all_artist_tracks is not none %}
                 <p class="text-center text-gray-500 italic mb-4">No public tracks found for {{ artist_name }}.</p>
            {% else %}
                 <p class="text-center text-red-400 italic mb-4">Could not load tracks for {{ artist_name }}.</p>
            {% endif %}

            {# 2. Optional Keywords #}
            <h2 class="text-xl font-semibold mb-3 text-center mt-6">2. Add Optional Search Keywords</h2>
             <div class="mb-5">
                 <label for="user_keywords" class="block text-sm font-medium text-gray-300 mb-1">Enter additional keywords (comma-separated):</label>
                 <input type="text" name="user_keywords" id="user_keywords"
                        value="{{ request.args.get('user_keywords', '') }}"
                        placeholder="e.g., chill vibes, workout, study"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-green-500 focus:border-green-500 text-white">
             </div>

             {# --- Buttons Container --- #}
             <div class="space-y-4 mt-6">
                 <button type="submit" id="find-playlists-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-300 text-lg">
                    Find Playlists
                 </button>
                 <button type="button" id="contact-curators-button" onclick="showEmailOverlay()"
                         class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded transition duration-300 text-lg hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                     Generate & Send Emails...
                 </button>
                 <input type="hidden" id="playlists-data-hidden" value="">
             </div>
        </form>
    </div>{# End Left Column #}

    {# --- Right Column: Status & Results --- #}
    <div class="lg:col-span-5 bg-gray-850 p-6 rounded-lg shadow-inner border border-gray-700 flex flex-col">
        <h2 class="text-xl font-semibold mb-5 text-center text-gray-300">Search Status & Results</h2>
        <div id="progress-container" class="mb-4 p-4 bg-gray-700 rounded-lg shadow" style="display: none;">
            <div class="text-center text-sm font-medium text-gray-300 mb-2" id="progress-status">Initializing...</div>
            <div class="w-full bg-gray-600 rounded-full h-4 overflow-hidden">
                <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
            </div>
             <div id="keywords-display-area" class="mt-3 text-xs text-gray-400" style="display: none;">
                 <strong>Using keywords:</strong> <span id="keywords-list"></span>...
             </div>
        </div>
        <div id="playlist-results-container" class="flex-grow min-h-[200px]">
            {% if not request.args.get('selected_track_id') %}
                <div class="flex items-center justify-center h-full">
                     <p class="text-center text-gray-500 italic">Select a song and click "Find Playlists" to see results.</p>
                </div>
            {% endif %}
        </div>
         <div id="email-status-container" class="mt-6 hidden">
              <h3 class="text-lg font-semibold mb-3 text-center text-gray-300">Email Sending Progress</h3>
              <div class="bg-gray-700 p-4 rounded-lg shadow max-h-60 overflow-y-auto custom-scrollbar">
                   <pre id="email-log" class="text-xs text-gray-300 whitespace-pre-wrap"></pre>
              </div>
         </div>
    </div>{# End Right Column #}

</div>{# End Main Grid #}

{# --- REVISED Email Overlay --- #}
<div id="email-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-4xl w-full max-h-[90vh] flex flex-col">
        <h2 class="text-2xl font-bold mb-4 text-center text-purple-300">Generate & Send Outreach Emails</h2>

        {# Top Section: Inputs & Generate Button #}
        <div class="mb-4 border-b border-gray-700 pb-4 flex-shrink-0">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                     <label for="song-description-editor" class="block text-gray-300 text-sm font-semibold mb-1">1. Song Description (for AI):</label>
                     <textarea id="song-description-editor" rows="5"
                               placeholder="e.g., A dreamy shoegaze track with ethereal vocals..."
                               class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 text-white text-sm"></textarea>
                </div>
                <div>
                     <label for="language-selector" class="block text-gray-300 text-sm font-semibold mb-1">2. Email Language:</label>
                     <select id="language-selector" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 text-white text-sm h-[42px]">
                         <option value="English" selected>English</option>
                         <option value="Spanish">Spanish</option>
                         <option value="French">French</option>
                         <option value="German">German</option>
                         <option value="Portuguese">Portuguese</option>
                         <option value="Italian">Italian</option>
                     </select>
                     <div class="mt-2">
                        <label for="bcc-email-input" class="block text-gray-300 text-sm font-semibold mb-1">3. Send a copy (BCC) to (optional):</label>
                        <input type="email" id="bcc-email-input" placeholder="your.verification.email@example.com" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 text-white text-sm">
                     </div>
                </div>
            </div>
            <button type="button" id="generate-email-button" onclick="generateEmailAction()" class="w-full md:w-1/2 mx-auto px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded transition duration-200 disabled:opacity-50 disabled:cursor-wait">
                 <span class="button-text">Generate Template & Preview</span>
                 <span class="button-loading animate-pulse hidden">Generating...</span>
            </button>
        </div>

        {# Bottom Section: Preview & Edit (Initially Hidden) #}
        <div id="email-preview-edit-section" class="hidden flex-grow min-h-0 overflow-hidden flex flex-col">
            <p class="text-sm text-gray-400 mb-1 flex-shrink-0">4. Review & Edit the generated template below.</p>
            <p class="text-xs text-yellow-400 mb-4 text-center flex-shrink-0">
                <strong class="font-semibold">Important:</strong> Personalize this template to improve deliverability! Emails will be sent slowly (25-60s delay) to respect rate limits.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow min-h-0 overflow-y-auto pr-2 custom-scrollbar">
                <div class="flex flex-col">
                    <label for="template-body-editor" class="block text-gray-300 text-sm font-semibold mb-2">Editable Template Body:</label>
                    <textarea id="template-body-editor" class="w-full h-full flex-grow p-3 bg-gray-900 border border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 text-white text-sm font-mono resize-none"></textarea>
                </div>
                <div class="flex flex-col">
                    <div class="mb-4 flex-shrink-0">
                        <label for="preview-subject-editor" class="block text-gray-300 text-sm font-semibold mb-1">Editable Subject Line:</label>
                        <input type="text" id="preview-subject-editor" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md focus:ring-purple-500 focus:border-purple-500 text-white text-sm">
                    </div>
                    <div class="flex-grow min-h-0 flex flex-col">
                         <strong class="block text-gray-300 text-sm font-semibold mb-1 flex-shrink-0">Preview (Using First Playlist):</strong>
                         <div class="p-3 bg-gray-700 rounded border border-gray-600 flex-grow overflow-y-auto custom-scrollbar">
                             <pre id="preview-body" class="text-sm text-gray-100 whitespace-pre-wrap min-h-[100px]"></pre>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        {# Footer Buttons #}
        <div class="mt-4 pt-4 border-t border-gray-600 flex justify-end space-x-4 flex-shrink-0">
            <button type="button" onclick="cancelEmailSend()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition duration-200">Cancel</button>
            <button type="button" id="confirm-send-button" onclick="confirmAndSendEmails()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded transition duration-200 hidden disabled:opacity-50">
                Confirm & Send All
            </button>
        </div>
    </div>
</div>

{# Link back to general search page #}
<div class="text-center mt-10">
    <a href="{{ url_for('main.search_artist') }}" class="inline-block px-6 py-2 bg-gray-600 rounded text-lg font-semibold hover:bg-gray-500 transition duration-300">
        ‚Üê Back to Artist Search
    </a>
</div>
{% endblock %}

{# --- JavaScript --- #}
{% block extra_js %}
<script>
    // Global variable to hold artist ID (can be useful)
    const currentArtistId = {{ artist_id | tojson }}; // Get artist_id from Flask context

    // --- Playlist Search Progress ---
    function updateProgress(percentage, statusText) {
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        const container = document.getElementById('progress-container');
        if (container) container.style.display = 'block';
        if (progressBar) progressBar.style.width = percentage + '%';
        // Sanitize status text slightly before displaying
        const displayStatus = statusText.replace(/</g, "<").replace(/>/g, ">");
        if (progressStatus) {
             progressStatus.innerHTML = `<span class="font-semibold text-green-400">${displayStatus}</span> (${percentage}%)`;
        }
    }
    function hideProgress() {
        const progressContainer = document.getElementById('progress-container');
        if (progressContainer) progressContainer.style.display = 'none';
        const findBtn = document.getElementById('find-playlists-button');
        if (findBtn) { findBtn.disabled = false; findBtn.innerHTML = 'Find Playlists'; }
    }
    function showSearchError(errorMessage) {
        hideProgress();
        const resultsContainer = document.getElementById('playlist-results-container');
        const displayError = errorMessage.replace(/</g, "<").replace(/>/g, ">");
        if(resultsContainer) {
             resultsContainer.innerHTML = `
                <div class="text-center p-6 bg-red-900 border border-red-700 rounded-lg shadow-xl">
                    <h3 class="text-xl font-semibold mb-2 text-red-100">Search Error</h3>
                    <p class="text-red-200">${displayError}</p>
                </div>`;
        }
        // Consider updating title based on artist name if available
        document.title = "Playlist Search Error for {{ artist_name | e }}";
        const emailButton = document.getElementById('contact-curators-button'); // Use correct ID
        if (emailButton) emailButton.classList.add('hidden');
    }

    // --- Keywords Display ---
     function updateKeywordsDisplay(keywords) {
        const displayArea = document.getElementById('keywords-display-area');
        const listSpan = document.getElementById('keywords-list');
        if (displayArea && listSpan && keywords && keywords.length > 0) {
            // Join first few keywords for preview
            listSpan.textContent = keywords.join(', ');
            displayArea.style.display = 'block';
        } else if (displayArea) {
            displayArea.style.display = 'none'; // Hide if no keywords
        }
    }

    // --- Show/Hide Email Button ---
    function showEmailButton() {
        const btn = document.getElementById('contact-curators-button'); // Use correct ID
        const playlistsDataInput = document.getElementById('playlists-data-hidden');
        if (btn && playlistsDataInput && playlistsDataInput.value && playlistsDataInput.value !== '[]') {
             btn.classList.remove('hidden');
        } else if (btn) {
             btn.classList.add('hidden');
        }
    }

    // --- Inject Results ---
    function injectResultsAndData(resultsHtml, playlistData) {
        const resultsContainer = document.getElementById('playlist-results-container');
        if (resultsContainer) resultsContainer.innerHTML = resultsHtml;
        const hiddenInput = document.getElementById('playlists-data-hidden');
        // Ensure playlistData is stringified before setting value
        if (hiddenInput) hiddenInput.value = JSON.stringify(playlistData || []);
        showEmailButton(); // Check if button should be shown after injecting data
    }

     // --- REVISED Email Overlay & Generation Logic ---
     let exampleCuratorName = '';
    let examplePlaylistName = '';

    function showEmailOverlay() {
        const overlay = document.getElementById('email-overlay');
        const descriptionEditor = document.getElementById('song-description-editor');
        const langSelector = document.getElementById('language-selector');
        const bccInput = document.getElementById('bcc-email-input');
        const previewEditSection = document.getElementById('email-preview-edit-section');
        const generateBtn = document.getElementById('generate-email-button');
        const sendBtn = document.getElementById('confirm-send-button');
        const templateEditor = document.getElementById('template-body-editor');
        const subjectEditor = document.getElementById('preview-subject-editor');
        const previewBody = document.getElementById('preview-body');

        // Reset state
        descriptionEditor.value = '';
        langSelector.value = 'English';
        bccInput.value = '';
        templateEditor.value = '';
        subjectEditor.value = '';
        previewBody.textContent = '';
        previewEditSection.classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.querySelector('.button-text').classList.remove('hidden');
        generateBtn.querySelector('.button-loading').classList.add('hidden');
        sendBtn.classList.add('hidden');
        sendBtn.disabled = true;

        if (overlay) {
            overlay.classList.remove('hidden');
        }
    }

    function generateEmailAction() {
        const subjectEditorEl = document.getElementById('preview-subject-editor');
        const previewBodyEl = document.getElementById('preview-body');
        const templateEditorEl = document.getElementById('template-body-editor');
        const descriptionEditor = document.getElementById('song-description-editor');
        const langSelector = document.getElementById('language-selector');
        const generateBtn = document.getElementById('generate-email-button');
        const sendBtn = document.getElementById('confirm-send-button');
        const previewEditSection = document.getElementById('email-preview-edit-section');
        const loadingText = generateBtn.querySelector('.button-loading');
        const buttonText = generateBtn.querySelector('.button-text');

        const selectedTrackInput = document.querySelector('input[name="selected_track_id"]:checked');
        const playlistsDataInput = document.getElementById('playlists-data-hidden');

        // Validation
        if (!selectedTrackInput) { alert('Please select a track first.'); return; }
        const songDescription = descriptionEditor.value.trim();
        if (!songDescription) { alert('Please enter a song description.'); descriptionEditor.focus(); return; }
        const language = langSelector.value;
        if (!language) { alert('Please select an email language.'); langSelector.focus(); return; }
        let playlists = []; try { playlists = JSON.parse(playlistsDataInput.value); } catch (e) { alert('Error reading playlist data.'); return; }
        const firstPlaylist = playlists.find(p => p && p.email && p.email.includes('@'));
        if (!firstPlaylist) { alert("No playlists with contactable emails found in results."); return; }

        // Store example names for live preview
        exampleCuratorName = firstPlaylist.owner_name || "Playlist Curator";
        if (exampleCuratorName.toLowerCase() === 'n/a' || exampleCuratorName.toLowerCase() === 'spotify') {
             exampleCuratorName = "Playlist Curator";
        }
        examplePlaylistName = firstPlaylist.name || "Your Playlist";

        const trackId = selectedTrackInput.value;

        // Show loading state
        generateBtn.disabled = true; loadingText.classList.remove('hidden'); buttonText.classList.add('hidden');
        previewEditSection.classList.add('hidden'); sendBtn.classList.add('hidden'); sendBtn.disabled = true;
        subjectEditorEl.value = 'Generating...'; subjectEditorEl.disabled = true;
        previewBodyEl.textContent = 'Generating...';
        templateEditorEl.value = 'Generating...'; templateEditorEl.disabled = true;

        const previewUrl = "{{ url_for('playlists.generate_preview_email_route') }}";
        fetch(previewUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ track_id: trackId, song_description: songDescription, language: language, playlist: firstPlaylist })
        })
        .then(response => {
            if (!response.ok) { return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) }); }
            return response.json();
        })
        .then(data => {
            if (data.error) { throw new Error(data.error); }
            subjectEditorEl.value = data.subject || '[Subject Generation Failed]';
            previewBodyEl.textContent = data.preview_body || '[Preview Generation Failed]';
            templateEditorEl.value = data.template_body || '[Template Generation Failed]';
            previewEditSection.classList.remove('hidden');
            if (data.template_body) {
                templateEditorEl.disabled = false;
                subjectEditorEl.disabled = false;
                sendBtn.classList.remove('hidden');
                sendBtn.disabled = false;
                 templateEditorEl.removeEventListener('input', updateLivePreview);
                 templateEditorEl.addEventListener('input', updateLivePreview);
            } else {
                templateEditorEl.disabled = true;
                subjectEditorEl.disabled = true;
                sendBtn.classList.add('hidden');
                sendBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error("Error fetching email preview/template:", error);
            subjectEditorEl.value = 'Error';
            previewBodyEl.textContent = `Failed to generate: ${error.message}`;
            templateEditorEl.value = `Failed to generate template: ${error.message}`;
        })
        .finally(() => {
            if (generateBtn) generateBtn.disabled = false;
            if (loadingText) loadingText.classList.add('hidden');
            if (buttonText) buttonText.classList.remove('hidden');
        });
    }

    function updateLivePreview() {
        const templateEditorEl = document.getElementById('template-body-editor');
        const previewBodyEl = document.getElementById('preview-body');
        if (!templateEditorEl || !previewBodyEl) return;
        const currentTemplateText = templateEditorEl.value;
        const renderedPreview = currentTemplateText
            .replace(/\{\{\s*curator_name\s*\}\}/g, exampleCuratorName)
            .replace(/\{\{\s*playlist_name\s*\}\}/g, examplePlaylistName);
        previewBodyEl.textContent = renderedPreview;
    }

    function cancelEmailSend() {
         const overlay = document.getElementById('email-overlay');
         if (overlay) overlay.classList.add('hidden');
         const templateEditorEl = document.getElementById('template-body-editor');
         if (templateEditorEl) templateEditorEl.removeEventListener('input', updateLivePreview);
    }

    function confirmAndSendEmails() {
        const templateEditorEl = document.getElementById('template-body-editor');
        const subjectEditorEl = document.getElementById('preview-subject-editor');
        const bccEmailInput = document.getElementById('bcc-email-input');
        const editedTemplateBody = templateEditorEl ? templateEditorEl.value.trim() : null;
        const editedSubject = subjectEditorEl ? subjectEditorEl.value.trim() : null;
        const bccEmail = bccEmailInput ? bccEmailInput.value.trim() : '';

        if (!editedSubject) { alert("Subject line cannot be empty."); subjectEditorEl.focus(); return; }
        if (!editedTemplateBody) { alert("Template body cannot be empty."); templateEditorEl.focus(); return; }
        if (editedTemplateBody.indexOf('{{curator_name}}') === -1 || editedTemplateBody.indexOf('{{playlist_name}}') === -1) {
             if (!confirm("The template seems to be missing the required placeholders. Send anyway?")) { return; }
        }
        if (bccEmail && !bccEmail.includes('@')) { alert("The BCC email address appears to be invalid."); bccEmailInput.focus(); return; }

        cancelEmailSend();

        const contactButton = document.getElementById('contact-curators-button');
        const emailStatusContainer = document.getElementById('email-status-container');
        const emailLog = document.getElementById('email-log');
        const selectedTrackInput = document.querySelector('input[name="selected_track_id"]:checked');
        const playlistsDataInput = document.getElementById('playlists-data-hidden');

        if (!selectedTrackInput || !playlistsDataInput) { console.error("Missing data for sending emails."); return; }
        const trackId = selectedTrackInput.value;
        let playlists = []; try { playlists = JSON.parse(playlistsDataInput.value); } catch (e) { console.error("Cannot parse playlist data for sending."); return; }
        const playlistsToContact = playlists.filter(p => p && p.email && p.email.includes('@'));
        if (playlistsToContact.length === 0) { alert("No playlists with valid emails found in results to contact."); return; }

        if (contactButton) { contactButton.disabled = true; contactButton.innerHTML = '<span class="animate-pulse">Sending Emails...</span>'; }
        if (emailLog) emailLog.textContent = 'Initializing email process...\nUsing edited template.\n';
        if (emailStatusContainer) emailStatusContainer.style.display = 'block';

        const sendUrl = "{{ url_for('playlists.send_emails_route') }}";
        fetch(sendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
            body: JSON.stringify({ track_id: trackId, playlists: playlistsToContact, subject: editedSubject, template_body: editedTemplateBody, bcc_email: bccEmail })
        })
        .then(response => { // Handle SSE stream
             if (!response.ok) { throw new Error(`Email sending failed: ${response.status} ${response.statusText}`); }
             if (!response.body) { throw new Error("Response body is missing for streaming."); }
             const reader = response.body.getReader();
             const decoder = new TextDecoder();
             function processStream({ done, value }) {
                 if (done) {
                     console.log("Email stream finished.");
                      if (contactButton) { // Reset the main page button
                          contactButton.disabled = false;
                          contactButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg> Generate & Send Emails...';
                      }
                     return;
                 }
                 const chunk = decoder.decode(value, { stream: true });
                 const lines = chunk.split('\n');
                 lines.forEach(line => { // Process SSE lines
                      line = line.trim();
                      if (line.startsWith('event:')) {
                          const eventType = line.substring(6).trim();
                          const dataLineInChunk = lines.slice(lines.indexOf(line) + 1).find(l => l.trim().startsWith('data:'));
                          if (dataLineInChunk) {
                              const eventData = dataLineInChunk.trim().substring(5).trim();
                              if (emailLog) { let logPrefix = ''; if(eventType === 'success') logPrefix = '‚úÖ '; else if(eventType === 'error') logPrefix = '‚ùå '; else if(eventType === 'status') logPrefix = '‚è≥ '; else if(eventType === 'done') logPrefix = 'üèÅ '; emailLog.textContent += logPrefix + eventData + '\n'; emailLog.scrollTop = emailLog.scrollHeight; }
                          } else if (line === 'event: done') { if (emailLog) emailLog.textContent += 'üèÅ Finished.\n'; }
                      }
                 });
                 reader.read().then(processStream);
             }
             reader.read().then(processStream);
        })
        .catch(error => { // Handle fetch/stream error
             console.error("Error sending emails:", error);
             if (emailLog) emailLog.textContent += `\n‚ùå Network or processing error: ${error.message}\n`;
             if (contactButton) { // Reset main page button
                 contactButton.disabled = false;
                 contactButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg> Generate & Send Emails...';
             }
        });
    }

     // --- Find Playlist Form Submit Listener ---
     const findForm = document.getElementById('playlist-finder-form');
     if(findForm) {
         findForm.addEventListener('submit', function(event) {
             const selectedRadio = findForm.querySelector('input[name="selected_track_id"]:checked');
             // Removed description check from here
             if (!selectedRadio) { alert("Please select a track."); event.preventDefault(); return; }
             // if (!descriptionInput || !descriptionInput.value.trim()) { alert("Please enter a song description."); descriptionInput.focus(); event.preventDefault(); return; }
             const findButton = findForm.querySelector('#find-playlists-button');
             if(findButton) { findButton.disabled = true; findButton.innerHTML = '<span class="animate-pulse">Finding...</span>'; }
             // Clear previous results/logs
             const emailButton = document.getElementById('contact-curators-button'); if (emailButton) emailButton.classList.add('hidden');
             const emailStatusContainer = document.getElementById('email-status-container'); if (emailStatusContainer) { emailStatusContainer.style.display = 'none'; emailStatusContainer.querySelector('#email-log').textContent = ''; }
             const progressContainer = document.getElementById('progress-container'); if (progressContainer) progressContainer.style.display = 'block';
             const resultsContainer = document.getElementById('playlist-results-container'); if (resultsContainer) { resultsContainer.innerHTML = ''; }
             // Reset keywords display on new search
             const keywordsDisplay = document.getElementById('keywords-display-area'); if (keywordsDisplay) keywordsDisplay.style.display = 'none';
         });
     }

</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles */
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #4b5563 #374151; }
    #template-body-editor { font-family: monospace; min-height: 200px; }
    #email-preview-edit-section .grid > div { display: flex; flex-direction: column; }
    #email-preview-edit-section .grid > div > div:last-child { flex-grow: 1; display: flex; flex-direction: column; }
    #email-preview-edit-section .grid > div > div:last-child > div { flex-grow: 1; }
</style>
{% endblock %}
{# --- END OF FILE templates/show_playlist_finder_base.html --- #}