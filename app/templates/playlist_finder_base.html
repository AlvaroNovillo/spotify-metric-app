{# --- START OF FILE templates/playlist_finder_base.html --- #}
{% extends 'base.html' %}

{% block title %}
    {% if selected_track_name %}
        Playlist Results for {{ selected_track_name }}
    {% elif loading %}
        Searching Playlists...
    {% else %}
        Find Playlists & Contact Curators
    {% endif %}
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4 text-center">Find Playlists & Contact Curators</h1>
<p class="text-center text-gray-400 text-sm mb-6">Select a track, describe it, find relevant playlists, and contact curators (experimental).</p>

{# Disclaimer #}
<div class="max-w-7xl mx-auto bg-yellow-900 border border-yellow-700 text-yellow-100 px-4 py-3 rounded relative mb-8" role="alert">
  <strong class="font-bold">Warning:</strong>
  <span class="block sm:inline"> Playlist finding uses an external, undocumented service (PlaylistSupply) via scraping. Email generation uses AI (Gemini). Both require stored credentials and are <strong class="underline">experimental and likely to break</strong> without notice. Use responsibly and ensure compliance with all terms of service.</span>
</div>

{# --- Main Content Area (Two Columns) --- #}
<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

    {# --- Left Column (Wider): Form --- #}
    <div class="lg:col-span-7 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
        <form method="GET" action="{{ url_for('playlists.playlist_finder') }}" id="playlist-finder-form">
            {# 1. Track Selection #}
            <h2 class="text-xl font-semibold mb-5 text-center">1. Select Track by {{ artist_name }}</h2>
            {% if top_tracks %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar">
                    {% for track in top_tracks %}
                    <label class="flex items-center bg-gray-700 p-3 rounded-lg shadow hover:bg-gray-650 transition duration-200 cursor-pointer border-2 border-transparent has-[:checked]:border-green-500 has-[:checked]:bg-gray-700 group">
                         <input type="radio" name="selected_track_id" value="{{ track.id }}" class="absolute opacity-0 w-0 h-0 peer" required
                               {% if track.id == request.args.get('selected_track_id') %}checked{% endif %}>
                         {% if track.album and track.album.images %}
                            <img src="{{ track.album.images[-1].url }}" alt="{{ track.album.name }} Cover" class="w-12 h-12 rounded flex-shrink-0 object-cover mr-3 border border-gray-600">
                         {% else %}
                            <div class="w-12 h-12 rounded flex-shrink-0 bg-gray-600 flex items-center justify-center mr-3 text-gray-500 text-xl">?</div>
                         {% endif %}
                         <div class="flex-grow overflow-hidden">
                             <span class="block text-sm font-medium text-gray-100 truncate group-hover:text-white" title="{{ track.name }}">{{ track.name }}</span>
                             <span class="block text-xs text-gray-400 truncate" title="{{ track.artists | map(attribute='name') | join(', ') }}">{{ track.artists | map(attribute='name') | join(', ') }}</span>
                         </div>
                         <div class="ml-auto flex-shrink-0 w-6 h-6 rounded-full border-2 border-gray-500 group-has-[:checked]:border-green-500 group-has-[:checked]:bg-green-500 flex items-center justify-center transition-colors duration-200">
                              <svg class="w-3 h-3 text-white opacity-0 group-has-[:checked]:opacity-100 transition-opacity duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                         </div>
                    </label>
                    {% endfor %}
                </div>
            {% elif top_tracks is not none %}
                <p class="text-center text-gray-500 italic mb-4">No top tracks found for {{ artist_name }}.</p>
            {% else %}
                 <p class="text-center text-red-400 italic mb-4">Could not load top tracks for {{ artist_name }}.</p>
            {% endif %}

             {# 2. Song Description #}
            <h2 class="text-xl font-semibold mb-3 text-center mt-6">2. Describe Your Song (for AI)</h2>
            <div class="mb-5">
                 <label for="song_description" class="block text-sm font-medium text-gray-300 mb-1">Enter a short description (mood, genre, selling points):</label>
                 <textarea name="song_description" id="song_description" rows="4"
                           placeholder="e.g., A dreamy shoegaze track with ethereal vocals and layered guitars, perfect for late-night listening or introspective moments."
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-green-500 focus:border-green-500 text-white"
                           required>{{ song_description }}</textarea> {# Use passed value for stickiness #}
             </div>

            {# 3. Optional Keywords #}
            <h2 class="text-xl font-semibold mb-3 text-center mt-6">3. Add Optional Search Keywords</h2>
             <div class="mb-5">
                 <label for="user_keywords" class="block text-sm font-medium text-gray-300 mb-1">Enter additional keywords (comma-separated):</label>
                 <input type="text" name="user_keywords" id="user_keywords"
                        value="{{ user_keywords }}" {# Use passed value #}
                        placeholder="e.g., chill vibes, workout, study"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-green-500 focus:border-green-500 text-white">
             </div>

             {# --- Buttons Container --- #}
             <div class="space-y-4 mt-6">
                 {# 4. Submit Button for Finding Playlists #}
                 <button type="submit" id="find-playlists-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-300 text-lg"
                         {% if not top_tracks %}disabled title="Top tracks need to load first"{% endif %}>
                    Find Playlists
                 </button>

                 {# 5. Send Emails Button (Initially Hidden) - Added below Find button #}
                 <button type="button" id="send-emails-button" onclick="showEmailPreview(event)"
                         class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded transition duration-300 text-lg hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>
                     Contact Curators (Preview First)
                 </button>
                 {# Hidden input to store playlist data - populated by JS #}
                 <input type="hidden" id="playlists-data-hidden" value="">
             </div>
        </form>
    </div>{# End Left Column #}

    {# --- Right Column: Status & Results --- #}
    <div class="lg:col-span-5 bg-gray-850 p-6 rounded-lg shadow-inner border border-gray-700 flex flex-col"> {# Flex col for layout #}
        <h2 class="text-xl font-semibold mb-5 text-center text-gray-300">Search Status & Results</h2>

        {# Playlist Search Progress Bar Placeholder #}
        <div id="progress-container" class="mb-6 p-4 bg-gray-700 rounded-lg shadow" style="display: none;"> {# Hide initially #}
            <div class="text-center text-sm font-medium text-gray-300 mb-2" id="progress-status">Initializing search...</div>
            <div class="w-full bg-gray-600 rounded-full h-4 overflow-hidden">
                <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
            </div>
        </div>

        {# Results Placeholder (Dynamically filled) #}
        <div id="playlist-results-container" class="flex-grow min-h-[200px]"> {# Ensure it has some min height #}
            {# Content will be loaded here via streaming #}
            {% if not search_performed and not loading %} {# Show initial message only if not loading/searching #}
                <div class="flex items-center justify-center h-full">
                     <p class="text-center text-gray-500 italic">Select a track, describe it, and click "Find Playlists" to see results here.</p>
                </div>
            {% endif %}
        </div>

         {# Email Sending Feedback Placeholder #}
         <div id="email-status-container" class="mt-6 hidden"> {# Hide initially #}
              <h3 class="text-lg font-semibold mb-3 text-center text-gray-300">Email Sending Progress</h3>
              <div class="bg-gray-700 p-4 rounded-lg shadow max-h-60 overflow-y-auto custom-scrollbar">
                   <pre id="email-log" class="text-xs text-gray-300 whitespace-pre-wrap"></pre>
              </div>
         </div>

    </div>{# End Right Column #}

</div>{# End Main Grid #}

{# --- Email Preview Overlay --- #}
<div id="email-preview-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[85vh] flex flex-col"> {# Flex col #}
        <h2 class="text-2xl font-bold mb-4 text-center text-purple-300">Email Preview</h2>
        <p class="text-sm text-gray-400 mb-4">Review the AI-generated email for the <strong class="text-gray-200">first valid contact</strong> before sending to all curators.</p>

        {# Preview Content Area (Scrollable) #}
        <div class="flex-grow overflow-y-auto mb-4 pr-2 custom-scrollbar">
            <div class="mb-4 p-3 bg-gray-700 rounded border border-gray-600">
                <strong class="block text-gray-300 text-sm mb-1">Subject:</strong>
                <p id="preview-subject" class="text-sm text-gray-100"></p>
            </div>
            <div class="p-3 bg-gray-700 rounded border border-gray-600">
                 <strong class="block text-gray-300 text-sm mb-1">Body:</strong>
                 <pre id="preview-body" class="text-sm text-gray-100 whitespace-pre-wrap"></pre>
            </div>
        </div>

        <p class="text-xs text-yellow-400 mb-4 text-center flex-shrink-0">
             Note: The placeholder "[Your Name/Artist Name]" may appear. Emails will be sent sequentially with delays to avoid rate limits.
        </p>
        <div class="flex justify-end space-x-4 flex-shrink-0">
            <button type="button" onclick="cancelEmailSend()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded transition duration-200">Cancel</button>
            <button type="button" id="confirm-send-button" onclick="confirmAndSendEmails()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded transition duration-200 disabled:opacity-50" disabled>
                <span class="button-text">Confirm & Send All</span>
                <span class="button-loading animate-pulse hidden">Generating...</span> {# For preview generation #}
            </button>
        </div>
    </div>
</div>

{# Link back #}
<div class="text-center mt-10">
    <a href="{{ url_for('main.artist_dashboard') }}" class="inline-block px-6 py-2 bg-gray-600 rounded text-lg font-semibold hover:bg-gray-500 transition duration-300">
        ‚Üê Back to My Artist
    </a>
</div>
{% endblock %}

{# --- JavaScript --- #}
{% block extra_js %}
<script>
    // --- Playlist Search Progress ---
    function updateProgress(percentage, keyword) {
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        const container = document.getElementById('progress-container');
        if (container) container.style.display = 'block'; // Make sure it's visible
        if (progressBar) progressBar.style.width = percentage + '%';
        if (progressStatus) {
            const displayKeyword = keyword.replace(/</g, "<").replace(/>/g, ">");
            progressStatus.innerHTML = `Searching keyword: <span class="font-semibold text-green-400">${displayKeyword}</span>... (${percentage}%)`;
        }
    }
    function hideProgress() {
        const progressContainer = document.getElementById('progress-container');
        if (progressContainer) progressContainer.style.display = 'none';
        const findBtn = document.getElementById('find-playlists-button');
        if (findBtn) { findBtn.disabled = false; findBtn.innerHTML = 'Find Playlists'; }
    }
    function showSearchError(errorMessage) {
        hideProgress();
        const resultsContainer = document.getElementById('playlist-results-container');
        const displayError = errorMessage.replace(/</g, "<").replace(/>/g, ">");
        if(resultsContainer) {
             resultsContainer.innerHTML = `
                <div class="text-center p-6 bg-red-900 border border-red-700 rounded-lg shadow-xl">
                    <h3 class="text-xl font-semibold mb-2 text-red-100">Search Error</h3>
                    <p class="text-red-200">${displayError}</p>
                </div>`;
        }
        document.title = "Playlist Search Error";
        // Ensure email button is hidden on error
        const emailButton = document.getElementById('send-emails-button');
        if (emailButton) emailButton.classList.add('hidden');
    }

    function showEmailButton() {
        const btn = document.getElementById('send-emails-button');
        const playlistsDataInput = document.getElementById('playlists-data-hidden');
        // Only show if there's actually playlist data stored
        if (btn && playlistsDataInput && playlistsDataInput.value && playlistsDataInput.value !== '[]') {
             btn.classList.remove('hidden');
        } else if (btn) {
             btn.classList.add('hidden'); // Hide if no results
        }
    }

    function injectResultsAndData(resultsHtml, playlistData) {
        const resultsContainer = document.getElementById('playlist-results-container');
        if (resultsContainer) resultsContainer.innerHTML = resultsHtml;
        const hiddenInput = document.getElementById('playlists-data-hidden');
        if (hiddenInput) hiddenInput.value = JSON.stringify(playlistData || []);
        // Check again if we should show the email button now that data is injected
        showEmailButton();
    }

    // --- Email Preview & Sending Logic ---
    function showEmailPreview(event) {
        event.preventDefault();
        const overlay = document.getElementById('email-preview-overlay');
        const subjectEl = document.getElementById('preview-subject');
        const bodyEl = document.getElementById('preview-body');
        const confirmBtn = document.getElementById('confirm-send-button');
        const loadingText = confirmBtn ? confirmBtn.querySelector('.button-loading') : null;
        const buttonText = confirmBtn ? confirmBtn.querySelector('.button-text') : null;

        const selectedTrackInput = document.querySelector('input[name="selected_track_id"]:checked');
        const songDescriptionInput = document.getElementById('song_description');
        const playlistsDataInput = document.getElementById('playlists-data-hidden');

        if (!selectedTrackInput) { alert('Please select a track first.'); return; }
        if (!songDescriptionInput || !songDescriptionInput.value.trim()) { alert('Please enter a song description.'); songDescriptionInput.focus(); return; }
        if (!playlistsDataInput || !playlistsDataInput.value) { alert('Playlist data not found.'); return; }

        let playlists = [];
        try { playlists = JSON.parse(playlistsDataInput.value); } catch (e) { alert('Error reading playlist data.'); return; }
        const firstPlaylist = playlists.find(p => p && p.email && p.email.includes('@'));

        if (!firstPlaylist) { alert("No playlists with contactable emails found to generate a preview."); return; }

        const trackId = selectedTrackInput.value;
        const description = songDescriptionInput.value.trim();

        // Show loading state
        subjectEl.textContent = 'Generating...'; bodyEl.textContent = 'Generating preview content with AI...';
        if (confirmBtn) confirmBtn.disabled = true;
        if (loadingText) loadingText.classList.remove('hidden');
        if (buttonText) buttonText.classList.add('hidden');
        if (overlay) overlay.classList.remove('hidden');

        // --- CORRECTED Fetch preview from backend ---
        fetch('/generate-preview-email', {
            // *** SPECIFY METHOD, HEADERS, BODY ***
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
             },
            body: JSON.stringify({
                track_id: trackId,
                song_description: description,
                playlist: firstPlaylist // Send only the first valid playlist
            })
            // *** END OF CORRECTION ***
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `HTTP error ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                 throw new Error(data.error);
            }
            subjectEl.textContent = data.subject || '[Subject Generation Failed]';
            bodyEl.textContent = data.body || '[Body Generation Failed]';
            if (confirmBtn) confirmBtn.disabled = false;
        })
        .catch(error => {
            console.error("Error fetching email preview:", error);
            subjectEl.textContent = 'Error';
            bodyEl.textContent = `Failed to generate preview: ${error.message}`;
            if (confirmBtn) confirmBtn.disabled = true; // Keep disabled on error
        })
        .finally(() => { // Hide loading text regardless of outcome
             if (loadingText) loadingText.classList.add('hidden');
             if (buttonText) buttonText.classList.remove('hidden');
        });
    }

    function cancelEmailSend() {
         const overlay = document.getElementById('email-preview-overlay');
         if (overlay) overlay.classList.add('hidden');
    }

    function confirmAndSendEmails() {
        cancelEmailSend(); // Hide preview first
        const sendButton = document.getElementById('send-emails-button');
        const emailStatusContainer = document.getElementById('email-status-container');
        const emailLog = document.getElementById('email-log');
        const selectedTrackInput = document.querySelector('input[name="selected_track_id"]:checked');
        const songDescriptionInput = document.getElementById('song_description');
        const playlistsDataInput = document.getElementById('playlists-data-hidden');

        if (!selectedTrackInput || !songDescriptionInput || !playlistsDataInput) { console.error("Missing data for sending emails."); return; }
        const trackId = selectedTrackInput.value; const description = songDescriptionInput.value.trim();
        let playlists = []; try { playlists = JSON.parse(playlistsDataInput.value); } catch (e) { console.error("Cannot parse playlist data for sending."); return; }
        const playlistsToContact = playlists.filter(p => p && p.email && p.email.includes('@'));
        if (playlistsToContact.length === 0) { console.log("No playlists with emails to contact."); return; }

        if (sendButton) { sendButton.disabled = true; sendButton.innerHTML = '<span class="animate-pulse">Sending Emails...</span>'; }
        if (emailLog) emailLog.textContent = 'Initializing email process...\n';
        if (emailStatusContainer) emailStatusContainer.style.display = 'block';

        // Fetch API for POST with streaming body
        console.log("Starting Fetch POST for /send-emails");
        fetch('/send-emails', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
            body: JSON.stringify({
                track_id: trackId,
                song_description: description,
                playlists: playlistsToContact
            })
        })
        .then(response => { /* ... (fetch response handling same as before) ... */ })
        .catch(error => { /* ... (fetch error handling same as before) ... */ });
    }

     // --- Find Playlist Form Submit Listener (Adjusted) ---
     const findForm = document.getElementById('playlist-finder-form');
     if(findForm) {
         findForm.addEventListener('submit', function(event) {
             const selectedRadio = findForm.querySelector('input[name="selected_track_id"]:checked');
             const descriptionInput = document.getElementById('song_description');

             if (!selectedRadio) { alert("Please select a track."); event.preventDefault(); return; }
             if (!descriptionInput || !descriptionInput.value.trim()) { alert("Please enter a song description."); descriptionInput.focus(); event.preventDefault(); return; }

             const findButton = findForm.querySelector('#find-playlists-button'); // Target specific button
             if(findButton) { findButton.disabled = true; findButton.innerHTML = '<span class="animate-pulse">Finding...</span>'; }

             // Hide email button and clear log if visible
             const emailButton = document.getElementById('send-emails-button');
             if (emailButton) emailButton.classList.add('hidden');
             const emailStatusContainer = document.getElementById('email-status-container');
             if (emailStatusContainer) { emailStatusContainer.style.display = 'none'; emailStatusContainer.querySelector('#email-log').textContent = ''; }

             // Show progress bar
             let progressContainer = document.getElementById('progress-container');
             if (progressContainer) progressContainer.style.display = 'block';
              else { /* Optionally create progress elements dynamically if needed */ }

             const resultsContainer = document.getElementById('playlist-results-container');
             if (resultsContainer) { resultsContainer.innerHTML = ''; } // Clear previous results
         });
     }

</script>
{% endblock %}

{# --- Keep extra_css block --- #}
{% block extra_css %}
<style>
    /* Custom scrollbar styles ... */
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #374151; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #4b5563 #374151; }
</style>
{% endblock %}

{# --- END OF FILE templates/playlist_finder_base.html --- #}