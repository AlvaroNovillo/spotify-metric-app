{# --- REVISED playlist_finder_base.html --- #}
{% extends 'base.html' %}

{% block title %}Find Playlists - {{ artist_name }}{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="text-center mb-8">
        <h1>Find Playlists for <span style="color: var(--primary);">{{ artist_name }}</span></h1>
        <p class="text-secondary mt-4">Select a song to find relevant playlists</p>
    </div>

    <div class="grid gap-8" style="grid-template-columns: 1fr 1fr;">
        {# --- Left Column: Song Selection --- #}
        <div class="card" style="height: fit-content;">
            <form id="playlist-finder-form" method="GET"
                action="{{ url_for('playlists.show_playlist_finder', artist_id=artist_id) }}">
                <input type="hidden" name="artist_name" value="{{ artist_name }}">

                <h2 style="font-size: 1.25rem; margin-bottom: 1rem; text-align: center;">1. Select a Song</h2>

                {# Song Search Bar #}
                <div class="form-group" style="position: relative;">
                    <input type="search" id="song-search-input" placeholder="Search for a song..." class="form-input"
                        style="padding-left: 2.5rem;">
                    <svg style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 1.25rem; height: 1.25rem; color: var(--text-muted);"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                {# Song List #}
                {% if all_artist_tracks %}
                <div id="song-list-container"
                    style="max-height: 400px; overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1.5rem;"
                    class="custom-scrollbar">
                    {% for release_id, release in all_artist_tracks.items() %}
                    <details class="release-accordion" style="margin-bottom: 0.5rem;"
                        data-release-name="{{ release.name | lower }}">
                        <summary>
                            <div class="flex items-center gap-2" style="overflow: hidden;">
                                <img src="{{ release.images[-1].url if release.images else 'https://via.placeholder.com/40' }}"
                                    alt="Cover"
                                    style="width: 2.5rem; height: 2.5rem; border-radius: var(--radius-sm); object-fit: cover;">
                                <div style="overflow: hidden;">
                                    <span
                                        style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;">{{
                                        release.name }}</span>
                                    <span style="font-size: 0.75rem; color: var(--text-muted);">{{
                                        release.release_date.split('-')[0] if release.release_date }}</span>
                                </div>
                            </div>
                            <span style="color: var(--text-muted);">▼</span>
                        </summary>
                        <div class="space-y-2">
                            {% for track in release.tracks %}
                            <label class="song-item-label" data-track-name="{{ track.name | lower }}">
                                <input type="radio" name="selected_track_id" value="{{ track.id }}" class="hidden"
                                    required {% if track.id==request.args.get('selected_track_id') %}checked{% endif %}>
                                <span
                                    style="font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem;">{{
                                    track.name }}</span>
                                <div class="radio-indicator">
                                    <svg style="width: 0.75rem; height: 0.75rem; color: #000;" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </details>
                    {% endfor %}
                </div>
                <p id="no-song-results" class="hidden"
                    style="text-align: center; color: var(--text-muted); font-style: italic;">No
                    songs match your
                    search.</p>
                {% elif all_artist_tracks is not none %}
                <p style="text-align: center; color: var(--text-muted);">No public tracks found.</p>
                {% else %}
                <p style="text-align: center; color: var(--error);">Could not load tracks.</p>
                {% endif %}

                {# Keywords #}
                <div style="margin-top: 2rem;">
                    <h2 style="font-size: 1.25rem; margin-bottom: 1rem; text-align: center;">2. Optional Keywords</h2>
                    <div class="form-group">
                        <label for="user_keywords" class="form-label">Enter additional keywords
                            (comma-separated):</label>
                        <input type="text" name="user_keywords" id="user_keywords"
                            value="{{ request.args.get('user_keywords', '') }}"
                            placeholder="e.g., chill vibes, workout, study" class="form-input">
                    </div>
                </div>

                {# Actions #}
                <div class="flex flex-col gap-4 mt-6">
                    <button type="submit" id="find-playlists-button" class="btn btn-primary"
                        style="width: 100%; font-size: 1.1rem;">
                        <span class="button-text">Find Playlists</span>
                        <span class="button-loading hidden animate-spin">Searching...</span>
                    </button>

                    <div id="post-search-actions" class="hidden flex flex-col gap-4">
                        <button type="button" id="contact-curators-button" class="btn"
                            style="background-color: var(--accent-purple); color: white; width: 100%;">Contact
                            Curators...</button>
                        <button type="button" id="show-download-modal-btn" class="btn"
                            style="background-color: var(--success); color: white; width: 100%;">Download
                            Results...</button>
                    </div>
                </div>
            </form>
        </div>

        {# --- Right Column: Results --- #}
        <div class="card" style="display: flex; flex-direction: column; min-height: 500px;">
            <h2 style="font-size: 1.25rem; margin-bottom: 1.5rem; text-align: center;">Search Results</h2>

            <div id="progress-container"
                style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: var(--radius-md);">
                <div id="progress-status" style="text-align: center; font-size: 0.9rem; margin-bottom: 0.5rem;">
                    Initializing...</div>
                <div
                    style="width: 100%; height: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 1rem; overflow: hidden;">
                    <div id="progress-bar"
                        style="width: 0%; height: 100%; background: var(--success); transition: width 0.3s ease;"></div>
                </div>
                <div id="keywords-display-area"
                    style="display: none; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                    <strong>Using keywords:</strong> <span id="keywords-list"></span>...
                </div>
            </div>

            <div id="playlist-results-container" style="flex-grow: 1;">
                {% if not request.args.get('selected_track_id') %}
                <div
                    style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-style: italic;">
                    Select a song and click "Find Playlists" or upload a file.
                </div>
                {% endif %}
            </div>

            <div id="email-status-container" style="display: none; margin-top: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem; text-align: center;">Email Sending Progress</h3>
                <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: var(--radius-md); max-height: 200px; overflow-y: auto;"
                    class="custom-scrollbar">
                    <pre id="email-log"
                        style="font-size: 0.75rem; color: var(--text-secondary); white-space: pre-wrap; font-family: monospace;"></pre>
                </div>
            </div>
        </div>

    </div>
</div>

{# --- Modals --- #}

{# Email Overlay #}
<div id="email-overlay" class="hidden"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem;">
    <div class="card"
        style="width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; padding: 0;">
        <div style="padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <h2 style="text-align: center; color: var(--accent-purple); margin-bottom: 1rem;">Generate & Send Outreach
                Emails</h2>

            <div class="grid gap-4"
                style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 1rem;">
                <div>
                    <label for="song-description-editor" class="form-label">1. Song Description (for AI):</label>
                    <textarea id="song-description-editor" rows="3"
                        placeholder="e.g., A dreamy shoegaze track with ethereal vocals..."
                        class="form-textarea"></textarea>
                </div>
                <div>
                    <label for="language-selector" class="form-label">2. Email Language:</label>
                    <select id="language-selector" class="form-select">
                        <option value="English" selected>English</option>
                        <option value="Spanish">Spanish</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                        <option value="Portuguese">Portuguese</option>
                        <option value="Italian">Italian</option>
                    </select>

                    <div style="margin-top: 1rem;">
                        <label for="email-limit-input" class="form-label">Max emails (Limit: 300):</label>
                        <input type="number" id="email-limit-input" value="300" min="1" max="300" class="form-input">
                    </div>

                    <div style="margin-top: 1rem;">
                        <label for="bcc-email-input" class="form-label">BCC (optional):</label>
                        <input type="email" id="bcc-email-input" placeholder="your.email@example.com"
                            class="form-input">
                    </div>
                </div>
            </div>

            <button type="button" id="generate-email-button" class="btn btn-primary"
                style="width: 100%; max-width: 300px; margin: 0 auto; display: flex;">
                <span class="button-text">Generate Template & Preview</span>
                <span class="button-loading animate-spin hidden">Generating...</span>
            </button>
        </div>

        <div id="email-preview-edit-section" class="hidden"
            style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; padding: 1.5rem;">
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">4. Review & Edit the
                generated template below.</p>
            <p style="font-size: 0.8rem; color: var(--warning); text-align: center; margin-bottom: 1rem;">
                <strong>Important:</strong> Emails are randomized and rate-limited.
            </p>

            <div class="grid gap-6"
                style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); flex-grow: 1; min-height: 0; overflow-y: auto;">
                <div class="flex flex-col">
                    <label for="template-body-editor" class="form-label">Editable Template Body:</label>
                    <textarea id="template-body-editor" class="form-textarea"
                        style="flex-grow: 1; font-family: monospace; resize: none;"></textarea>
                </div>
                <div class="flex flex-col">
                    <div style="margin-bottom: 1rem;">
                        <label for="preview-subject-editor" class="form-label">Editable Subject Line:</label>
                        <input type="text" id="preview-subject-editor" class="form-input">
                    </div>
                    <div class="flex flex-col flex-grow">
                        <strong class="form-label">Preview:</strong>
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: var(--radius-md); flex-grow: 1; overflow-y: auto;"
                            class="custom-scrollbar">
                            <pre id="preview-body"
                                style="font-size: 0.9rem; white-space: pre-wrap; font-family: inherit;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div
            style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: flex-end; gap: 1rem;">
            <button type="button" id="cancel-email-button" class="btn btn-secondary">Cancel</button>
            <button type="button" id="confirm-send-button" class="btn hidden"
                style="background-color: var(--accent-purple); color: white;">Confirm & Send All</button>
        </div>
    </div>
</div>

{# Download Modal #}
<div id="download-playlist-modal" class="hidden"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem;">
    <div class="card" style="width: 100%; max-width: 500px;">
        <h3 style="text-align: center; color: var(--success); margin-bottom: 1rem;">Download Results</h3>
        <p style="text-align: center; color: var(--text-muted); margin-bottom: 1.5rem;">Select columns to export.</p>

        <form id="download-playlist-form">
            <div class="grid gap-2" style="grid-template-columns: 1fr 1fr;">
                <label class="song-item-label"><input type="checkbox" name="columns" value="name" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Playlist Name</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="url" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Spotify URL</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="owner_name" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Curator Name</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="email" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Curator Email</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="followers" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Followers</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="tracks_total"
                        class="hidden"><span style="margin-left: 0.5rem;">Total Tracks</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="description"
                        class="hidden"><span style="margin-left: 0.5rem;">Description</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="found_by"
                        class="hidden"><span style="margin-left: 0.5rem;">Found By</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
                <label class="song-item-label"><input type="checkbox" name="columns" value="contacted" checked
                        class="hidden"><span style="margin-left: 0.5rem;">Contacted</span>
                    <div class="radio-indicator" style="border-radius: 4px;">✔</div>
                </label>
            </div>

            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" id="cancel-download-button" class="btn btn-secondary">Cancel</button>
                <button type="button" data-format="csv" class="download-playlist-btn btn btn-primary">Export
                    CSV</button>
                <button type="button" data-format="xlsx" class="download-playlist-btn btn"
                    style="background-color: var(--success); color: white;">Export XLSX</button>
            </div>
        </form>
    </div>
</div>

<div class="text-center mt-10">
    <a href="{{ url_for('main.search_artist') }}" class="btn btn-secondary">
        ← Back to Artist Search
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="{{ url_for('static', filename='js/playlist_finder.js') }}"></script>
{% endblock %}