{# --- REVISED _artist_display.html --- #}
{# Expects: 'display_artist', 'display_releases', 'top_tracks', 'release_stats', 'lastfm_tags' #}

{% if display_artist %}
{# --- Artist Header Card --- #}
<div class="card mb-6">
    <div class="grid" style="grid-template-columns: 300px 1fr; gap: calc(var(--spacing-xl) * 1.5); align-items: start;">
        {# Artist Image #}
        <div>
            {% if display_artist.images %}
            <img src="{{ display_artist.images[0].url }}" alt="{{ display_artist.name }}"
                style="width: 100%; border-radius: var(--radius-lg); aspect-ratio: 1; box-shadow: var(--shadow-lg);">
            {% else %}
            <div
                style="width: 100%; aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                <span class="text-muted">No Image</span>
            </div>
            {% endif %}
        </div>

        {# Artist Info #}
        <div>
            <h2 style="font-size: 3rem; margin-bottom: var(--spacing-md); color: var(--primary); line-height: 1.2;">{{
                display_artist.name }}</h2>
            {% if display_artist.external_urls and display_artist.external_urls.spotify %}
            <a href="{{ display_artist.external_urls.spotify }}" target="_blank" rel="noopener noreferrer"
                class="text-secondary hover:text-main mb-4" style="display: inline-block; font-size: 1rem;">
                View on Spotify â†—
            </a>
            {% endif %}

            {# Stats Grid - Responsive auto-fit ensures all boxes are visible #}
            <div class="grid gap-4 mb-6 mt-6" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div class="info-card">
                    <p class="info-card-title">Followers</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">
                        {% if display_artist.followers and display_artist.followers.total is not none %}
                        {{ "{:,}".format(display_artist.followers.total) }}
                        {% else %}N/A{% endif %}
                    </p>
                </div>
                <div class="info-card">
                    <p class="info-card-title">Popularity</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">
                        {% if display_artist.popularity is not none %}
                        {{ display_artist.popularity }}/100
                        {% else %}N/A{% endif %}
                    </p>
                    {% if display_artist.popularity is not none %}
                    <div class="progress-bar-wrapper mt-2">
                        <div class="progress-bar" style="width: {{ display_artist.popularity }}%;"></div>
                    </div>
                    {% endif %}
                </div>
                {% if release_stats and release_stats.total_releases > 0 %}
                <div class="info-card">
                    <p class="info-card-title">Total Releases</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">{{ release_stats.total_releases }}</p>
                </div>
                <div class="info-card">
                    <p class="info-card-title">Albums</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">{{ release_stats.album_count }}</p>
                </div>
                <div class="info-card">
                    <p class="info-card-title">Singles/EPs</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">{{ release_stats.single_count }}</p>
                </div>
                <div class="info-card">
                    <p class="info-card-title">Avg. Popularity</p>
                    <p class="info-card-value" style="font-size: 1.2rem;">
                        {{ release_stats.average_popularity if release_stats.average_popularity is not none else 'N/A'
                        }}
                    </p>
                </div>
                {% endif %}
            </div>

            {# Genres & Tags #}
            {% set spotify_genres_lower = (display_artist.genres or []) | map('lower') | list %}
            {% set lastfm_tags_lower = (lastfm_tags or []) | map('lower') | list %}
            {% set combined_tags = (spotify_genres_lower + lastfm_tags_lower) | unique | sort %}

            {% if combined_tags %}
            <div>
                <p class="text-muted mb-3" style="font-size: 0.9rem; text-transform: uppercase; font-weight: 600;">
                    Genres & Tags</p>
                <div class="flex flex-wrap gap-2">
                    {% for tag in combined_tags %}
                    {% if tag in spotify_genres_lower and tag in lastfm_tags_lower %}
                    <span class="badge badge-primary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                        title="Genre (Spotify) & Tag (Last.fm)">{{ tag }}</span>
                    {% elif tag in spotify_genres_lower %}
                    <span class="badge badge-primary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                        title="Genre (Spotify)">{{ tag }}</span>
                    {% elif tag in lastfm_tags_lower %}
                    <span class="badge badge-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                        title="Tag (Last.fm)">{{ tag }}</span>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# --- Top Tracks & Release Stats --- #}
<div class="grid gap-6 mb-6" style="grid-template-columns: 2fr 1fr;">
    {# Top Tracks #}
    <div class="card">
        <div class="section-header">
            <span class="section-icon">ðŸŽµ</span>
            <h3 class="section-title">Top Tracks</h3>
        </div>
        {% if top_tracks %}
        <ol
            style="list-style: decimal; list-style-position: inside; display: flex; flex-direction: column; gap: var(--spacing-sm);">
            {% for track in top_tracks %}
            <li class="flex justify-between items-center p-2" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                <div style="flex-grow: 1; overflow: hidden; margin-right: var(--spacing-md);">
                    <span class="font-semibold"
                        style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                        title="{{ track.name }}">{{ track.name }}</span>
                    <span class="text-muted" style="font-size: 0.8rem;">
                        Popularity: {{ track.popularity if track.popularity is not none else 'N/A' }}
                        {% if track.album and track.album.name %} â€¢ {{ track.album.name }}{% endif %}
                    </span>
                </div>
                {% if track.external_urls and track.external_urls.spotify %}
                <a href="{{ track.external_urls.spotify }}" target="_blank" rel="noopener noreferrer"
                    class="text-secondary hover:text-primary" title="Listen on Spotify">
                    <svg style="width: 1.25rem; height: 1.25rem;" fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.669 11.538a.498.498 0 0 1-.686.165c-1.879-1.147-4.243-1.407-7.027-.77a.499.499 0 0 1-.222-.973c3.048-.696 5.662-.397 7.77.892a.5.5 0 0 1 .166.686zm.979-2.178a.624.624 0 0 1-.858.205c-2.15-1.321-5.428-1.704-7.972-.932a.625.625 0 0 1-.362-1.194c2.905-.881 6.517-.454 8.986 1.06a.625.625 0 0 1 .206.858zm.084-2.268C10.154 5.56 5.9 5.419 3.438 6.166a.748.748 0 1 1-.434-1.432c2.825-.857 7.523-.692 10.492 1.07a.75.75 0 1 1-.754 1.298z" />
                    </svg>
                </a>
                {% endif %}
            </li>
            {% endfor %}
        </ol>
        {% elif top_tracks is not none %}
        <p class="text-center text-muted italic">No public top tracks found.</p>
        {% else %}
        <p class="text-center text-muted italic">Top tracks could not be loaded.</p>
        {% endif %}
    </div>

    {# Release Stats #}
    <div class="card">
        <div class="section-header">
            <span class="section-icon">ðŸ“Š</span>
            <h3 class="section-title">Release Summary</h3>
        </div>
        {% if release_stats and release_stats.total_releases > 0 %}
        <div class="flex flex-col gap-3" style="font-size: 0.9rem;">
            <div class="flex justify-between"
                style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: var(--spacing-xs);">
                <span class="text-secondary">Total Releases:</span>
                <span class="font-semibold">{{ release_stats.total_releases }}</span>
            </div>
            <div class="flex justify-between"
                style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: var(--spacing-xs);">
                <span class="text-secondary">Albums:</span>
                <span class="font-semibold">{{ release_stats.album_count }}</span>
            </div>
            <div class="flex justify-between"
                style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: var(--spacing-xs);">
                <span class="text-secondary">Singles/EPs:</span>
                <span class="font-semibold">{{ release_stats.single_count }}</span>
            </div>
            <div class="flex justify-between"
                style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: var(--spacing-xs);">
                <span class="text-secondary">Avg. Popularity:</span>
                <span class="font-semibold">{{ release_stats.average_popularity if release_stats.average_popularity is
                    not none else 'N/A' }}/100</span>
            </div>
            <div class="flex justify-between">
                <span class="text-secondary">Release Years:</span>
                <span class="font-semibold">
                    {% if release_stats.first_release_year and release_stats.last_release_year %}
                    {{ release_stats.first_release_year }} - {{ release_stats.last_release_year }}
                    {% elif release_stats.first_release_year %}
                    {{ release_stats.first_release_year }}
                    {% else %}N/A{% endif %}
                </span>
            </div>
        </div>
        <p class="text-muted text-center mt-4" style="font-size: 0.75rem; font-style: italic;">
            Based on {{ release_stats.total_releases }} most recent releases
        </p>
        {% else %}
        <p class="text-center text-muted italic">No release data available.</p>
        {% endif %}
    </div>
</div>

{# --- Releases Accordion --- #}
<div class="card">
    <div class="section-header">
        <span class="section-icon">ðŸ’¿</span>
        <h3 class="section-title">Releases (Albums & Singles)</h3>
    </div>
    {% if display_releases %}
    <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
        {% for release in display_releases %}
        <details style="margin-bottom: 0;">
            <summary class="flex justify-between items-center cursor-pointer">
                <div class="flex items-center gap-3" style="min-width: 0; flex-grow: 1;">
                    {% if release.images %}
                    <img src="{{ release.images[-1].url }}" alt="{{ release.name }}"
                        style="width: 3rem; height: 3rem; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0;">
                    {% else %}
                    <div
                        style="width: 3rem; height: 3rem; border-radius: var(--radius-sm); background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <span style="font-size: 0.75rem;">?</span>
                    </div>
                    {% endif %}
                    <div style="overflow: hidden;">
                        <span class="font-semibold"
                            style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                            title="{{ release.name }}">{{ release.name }}</span>
                        <span class="text-muted"
                            style="font-size: 0.8rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ release.album_type | capitalize }} â€¢ {{ release.release_date }}
                            {% if release.total_tracks_fetched is defined %} â€¢ {{ release.total_tracks_fetched }}
                            tracks{% endif %}
                        </span>
                    </div>
                </div>
            </summary>

            <div
                style="padding: var(--spacing-md); padding-top: var(--spacing-lg); border-top: 1px solid rgba(255,255,255,0.05); margin-top: var(--spacing-md);">
                {# Release Details #}
                <div class="grid gap-4 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="info-card">
                        <p class="info-card-title">Popularity</p>
                        <p class="info-card-value" style="font-size: 1.25rem;">
                            {% if release.popularity is defined %}{{ release.popularity }}/100{% else %}N/A{% endif %}
                        </p>
                        {% if release.popularity is defined %}
                        <div class="progress-bar-wrapper mt-1">
                            <div class="progress-bar" style="width: {{ release.popularity }}%;"></div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="info-card">
                        <p class="info-card-title">Label</p>
                        <p style="font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                            title="{{ release.label | default('N/A') }}">{{ release.label | default('N/A') }}</p>
                    </div>
                </div>

                {# Genres #}
                {% if release.genres %}
                <div class="mb-4">
                    <p class="text-muted mb-2" style="font-size: 0.85rem; text-transform: uppercase;">Genres</p>
                    <div class="flex flex-wrap gap-1">
                        {% for genre in release.genres %}
                        <span class="badge badge-secondary">{{ genre }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# Tracklist #}
                <h4 class="font-semibold mb-2"
                    style="padding-top: var(--spacing-md); border-top: 1px solid rgba(255,255,255,0.05);">
                    Tracklist
                </h4>
                {% if release.tracks and release.tracks.get('items') %}
                <ol
                    style="list-style: decimal; list-style-position: inside; display: flex; flex-direction: column; gap: var(--spacing-xs); font-size: 0.9rem;">
                    {% for track in release.tracks['items'] %}
                    <li class="flex justify-between items-center">
                        <span>{{ track.name }}
                            {% if track.duration_ms %}
                            <span class="text-muted" style="font-size: 0.75rem;">
                                ({{ (track.duration_ms / 60000) | round(0, 'floor') }}:{{
                                '%02d'|format((track.duration_ms / 1000) % 60) }})
                            </span>
                            {% endif %}
                        </span>
                        {% if track.external_urls and track.external_urls.spotify %}
                        <a href="{{ track.external_urls.spotify }}" target="_blank" rel="noopener noreferrer"
                            class="text-secondary hover:text-primary" style="font-size: 0.75rem;">â†—</a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ol>
                {% if release.tracks.next %}
                <p class="text-muted mt-2" style="font-size: 0.75rem; font-style: italic;">
                    (Showing first page of tracks. Use Spotify link for full list.)
                </p>
                {% endif %}
                {% else %}
                <p class="text-muted italic" style="font-size: 0.9rem;">Tracklist information could not be loaded.</p>
                {% endif %}

                {# Spotify Link #}
                {% if release.external_urls and release.external_urls.spotify %}
                <div class="mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.05);">
                    <a href="{{ release.external_urls.spotify }}" target="_blank" rel="noopener noreferrer"
                        class="text-secondary hover:text-primary" style="font-size: 0.9rem;">
                        View {{ release.album_type | capitalize }} on Spotify â†—
                    </a>
                </div>
                {% endif %}
            </div>
        </details>
        {% endfor %}
    </div>
    {% if display_releases | length >= 20 %}
    <p class="text-muted text-center mt-4" style="font-size: 0.8rem;">
        Showing details for up to 20 primary releases. More may be available on Spotify.
    </p>
    {% endif %}
    {% else %}
    <p class="text-center text-muted">No primary releases found for this artist.</p>
    {% endif %}
</div>

{% else %}
<div class="card text-center">
    <p class="text-muted">Artist data not available.</p>
</div>
{% endif %}